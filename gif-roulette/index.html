<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF룰렛 만들기</title>
    <script src="https://code.jquery.com/jquery-3.6.3.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/gif.js"></script>
</head>
<body>
    <div>
        <div id="work"></div>
        <!-- 
        <table>
            <tr>
                <td>
                    <div class="frame-img" id="frame-img-template">
                        <div class="img-div">
                            <svg class="frame-img-preview"></svg>
                        </div>
                    </div>
                </td>
                <td>
                    <button class="btn btn-outline-secondary" id="add-frame">+</button>
                </td>
            </tr>
        </table> -->
        <div class="input-group">
            <button class="btn btn-success" onclick="maker.render((url)=>{
                window.open(url);
            })">render!</button>
        </div>
        <div>
            <div class="input-group">
                <input type="text" class="width-inp" placeholder="width" onchange="if (isNaN(this.value)) this.value='500';">
                <input type="text" class="height-inp" placeholder="height" onchange="if (isNaN(this.value)) this.value='500';">
                <button class="btn btn-success" onclick="init({width:Number(this.parentElement.querySelector('.width-inp').value),height:Number(this.parentElement.querySelector('.height-inp').value)});">GIF룰렛 메이커 초기화</button>
            </div>
        </div>

        
    </div>
    <script>
        var GIF=window['GIF']?window['GIF']:null;
        var maker=null,work=null;
        function gifFrame(svg){
            this.svg=svg;
        }
        gifFrame.prototype={
            setSvg(svg){
                this.svg=svg;
            },
            getImg(){
                var svgEl = document.body.appendChild(document.createElement("svg"));
                svgEl.outerHTML=this.svg;
                var rtImg=new Image(svgEl.getAttribute("width"));
                rtImg.src=URL.createObjectURL(new Blob([svgEl.outerHTML],{type:'image/svg+xml'}));
                svgEl.remove();
                return rtImg;
            }
        }
        function gifRouletteFrame({width,height,text,background,fontFamily,duration}){
            this.svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">
                <rect width="${width}" height="${height}" fill="${background}" />
                <text x="100" y="100">
                    <tspan style="color:#fff;text-shadow:1px 1px 1px #000,-1px -1px 1px #000,-1px 1px 1px #000,1px -1px 1px #000;${fontFamily}">${text}</tspan>
                </text>
            </svg>`;
            this.duration=duration;
        }
        gifRouletteFrame.prototype={
            setOptions({width,height,text,background,fontFamily,duration}={width:500,height:500,text:"",background:null,fontFamily:"Gulim 16px",duration:25}){
            this.svg = `<svg width="${width}" height="${height}">
                <rect width="${width}" height="${height}" fill="${background}" />
                <text>
                    <tspan style="font-family:${fontFamily}">${text}</tspan>
                </text>
            </svg>`;
            this.duration=duration;
            }
        }
        function gifRouletteMaker(work,{width,height,quality,background}={width:500,height:500,quality:5,background:null}){
            var options={
                width,height,quality,background
            };
            this.gif = new GIF(options);
            this.options=options;
            //this.work=work instanceof HTMLElement?work:typeof work==='string'?document.getElementById(work):null;
            this.frames=[];
        }
        gifRouletteMaker.prototype={
            addFrame({width,height,text,background,fontFamily,duration}){
                this.frames.push(new gifRouletteFrame({width,height,text,background,fontFamily,duration}));
            },
            setGIF(){
                this.gif.frames=[];
                for (var frame of this.frames){
                    this.gif.addFrame(new gifFrame(frame.svg).getImg(),{delay:frame.duration});
                }
            },
            render(cbfunc){
                this.gif.on('finished',(blob)=>{
                    var blobUrl = URL.createObjectURL(blob);
                    if (typeof cbfunc==='function'||cbfunc instanceof Function) cbfunc(blobUrl);
                });
                this.gif.render();
            },
        }
        function getFrameOptionsFromInpGroup(groupEl){
            if (!(groupEl instanceof HTMLElement)){
                return {};
            }
            return {
                width:Number(groupEl.querySelector('.inp-width').value),
                height:Number(groupEl.querySelector('.inp-height').value),
                background:groupEl.querySelector('.inp-background').value,
                fontFamily:groupEl.querySelector('.inp-font-family').value,
                duration:Number(groupEl.querySelector('.inp-duration').value),
                text:groupEl.querySelector('.inp-text').value,
            }
        }
            var listGroupItemHTML=(idx)=>`<li class="frame-item list-group-item"><div class="input-group"><input class="inp-width" type="text" onchange="if (isNaN(this.value)) this.value='500';" placeholder="width" />
                <input class="inp-height" type="text" onchange="if (isNaN(this.value)) this.value='500';" placeholder="height" />
                    <input class="inp-background" type="text" placeholder="background colour" />
                        <input class="inp-font-family" type="text" placeholder="font family" />
                            <input class="inp-duration" type="text" onchange="if (isNaN(this.value)) this.value='25';" placeholder="duration" />
                            <input class="inp-text" type="text" placeholder="text" />
                <button class="btn btn-primary" onclick="maker.addFrame({width:500,height:500,text:'',background:'#000000',fontFamily:'Gulim 16px',duration:25}); maker.frames[${idx}].setOptions(getFrameOptionsFromInpGroup(this.parentElement));maker.setGIF();">set</button></div></li>`;
        function init({width,height}){
            maker=new gifRouletteMaker("",{width,height,quality:5,background:null});
            work=document.getElementById("work");
            work.innerHTML=`<ul class="list-group"><li class="list-group-item"><button class="btn btn-outline-secondary" onclick="this.parentElement.parentElement.innerHTML+=listGroupItemHTML(this.parentElement.parentElement.querySelectorAll('li.frame-item').length)">+ (new frame)</button></li></ul>`;
        }
    </script>
</body>
</html>